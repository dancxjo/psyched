#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
HOST_SHORT="${HOST:-$(hostname -s)}"
MODULES_DIR="${REPO_DIR}/hosts/${HOST_SHORT}/modules"
PSH_CLI="${REPO_DIR}/psh/main.ts"

if ! command -v deno >/dev/null 2>&1; then
  echo "[bringup] deno is required to launch modules. Install from https://deno.land/." >&2
  exit 1
fi

# Optionally source ROS/workspace environment
if [ -f "${REPO_DIR}/tools/setup_env.sh" ]; then
  set +u
  # shellcheck disable=SC1091
  source "${REPO_DIR}/tools/setup_env.sh"
  set -u
fi

if [ ! -d "${MODULES_DIR}" ]; then
  echo "[bringup] No modules directory for host '${HOST_SHORT}' at ${MODULES_DIR}. Nothing to launch." >&2
  exit 0
fi

shopt -s nullglob
entries=("${MODULES_DIR}"/*)
shopt -u nullglob

if (( ${#entries[@]} == 0 )); then
  echo "[bringup] No modules configured under ${MODULES_DIR}." >&2
  exit 0
fi

for entry in "${entries[@]}"; do
  if [ -d "$entry" ] || [ -L "$entry" ]; then
    module="$(basename "$entry")"
    echo "[bringup] Launching ${module} via psh mod"
    ( deno run -A "$PSH_CLI" mod "$module" launch ) &
  else
    echo "[bringup] Skipping $(basename "$entry"): not a module link" >&2
  fi
done

echo "[bringup] Launch commands dispatched in background."
exit 0

#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
PSH_CLI="${REPO_DIR}/psh/main.ts"

if ! command -v deno >/dev/null 2>&1; then
  echo "[run] deno is required to launch modules. Install from https://deno.land/ and retry." >&2
  exit 1
fi

print_help() {
  cat <<'USAGE'
Usage: ./tools/run [OPTIONS] MODULE [MODULE ...]

Launch module services using psh mod.

Options:
  --foreground   Run in foreground (default: background)
  --help         Show this message

Example:
  ./tools/run pilot gps
USAGE
}

if (( $# == 0 )); then
  print_help
  exit 1
fi

foreground=0
modules=()

while (( $# )); do
  case "$1" in
    --foreground)
      foreground=1
      shift
      ;;
    --help|-h)
      print_help
      exit 0
      ;;
    --*)
      echo "[run] Unknown option: $1" >&2
      exit 2
      ;;
    *)
      modules+=("$1")
      shift
      ;;
  esac
done

if (( ${#modules[@]} == 0 )); then
  echo "[run] No modules specified." >&2
  exit 1
fi

for module in "${modules[@]}"; do
  echo "[run] Launching ${module}"
  if (( foreground )); then
    deno run -A "$PSH_CLI" mod "$module" launch
  else
    ( deno run -A "$PSH_CLI" mod "$module" launch ) &
  fi
done

if (( ! foreground )); then
  echo "[run] Launch commands dispatched in background."
fi

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Knightykell Pilot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="date=no">
    <link rel="stylesheet" type="text/css" href="assets/lower-decks-padd.css">
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <audio id="audio1" src="assets/beep1.mp3" preload="auto"></audio>
    <audio id="audio2" src="assets/beep2.mp3" preload="auto"></audio>
    <audio id="audio3" src="assets/beep3.mp3" preload="auto"></audio>
    <audio id="audio4" src="assets/beep4.mp3" preload="auto"></audio>
    <div class="wrap-all">
        <div class="wrap">
            <div class="left-frame-top">
                <button onclick="playSoundAndRedirect('audio2', '#')" class="panel-1-button">KNIGHTYKELL</button>
                <div class="panel-2">02<span class="hop">-262000</span></div>
            </div>
            <div class="right-frame-top">
                <div class="banner">Pilot Interface &bull; <span class="font-alpha-blue"
                        data-source=" connectionStatus">Offline</span></div>
                <div class="data-cascade-button-group">
                    <div class="data-wrapper" id="controlCascade" role="group" aria-label="Control status cascade">
                        <div class="data-column" data-column="drive">
                            <div class="dc-header font-arctic-ice">DRIVE</div>
                            <div class="dc-row dc-row-1">
                                <span class="dc-key">LIN X</span>
                                <span class="dc-value font-arctic-ice blink" data-source="linearX">0.00</span>
                            </div>
                            <div class="dc-row dc-row-2">
                                <span class="dc-key">LIN Y</span>
                                <span class="dc-value font-night-rain" data-source="linearY">0.00</span>
                            </div>
                            <div class="dc-row dc-row-3">
                                <span class="dc-key">ANG Z</span>
                                <span class="dc-value font-alpha-blue" data-source="angularZ">0.00</span>
                            </div>
                            <div class="dc-row dc-row-4">
                                <span class="dc-key">MODE</span>
                                <span class="dc-value font-arctic-ice" data-source="robotMode">--</span>
                            </div>
                        </div>
                        <div class="data-column" data-column="safety">
                            <div class="dc-header">SAFETY</div>
                            <div class="dc-row dc-row-1">
                                <span class="dc-key">SPEED</span>
                                <span class="dc-value font-arctic-ice" data-source="robotSpeed">--</span>
                            </div>
                            <div class="dc-row dc-row-2">
                                <span class="dc-key">BUMPR</span>
                                <span class="dc-value font-night-rain blink" data-source="robotBumper">--</span>
                            </div>
                            <div class="dc-row dc-row-3">
                                <span class="dc-key">CLIFF</span>
                                <span class="dc-value font-night-rain" data-source="robotCliff">--</span>
                            </div>
                            <div class="dc-row dc-row-4">
                                <span class="dc-key">IR</span>
                                <span class="dc-value font-alpha-blue" data-source="robotIrOmni">--</span>
                            </div>
                        </div>
                        <div class="data-column" data-column="energy">
                            <div class="dc-header">ENERGY</div>
                            <div class="dc-row dc-row-1">
                                <span class="dc-key">BAT %</span>
                                <span class="dc-value font-arctic-ice blink" data-source="batteryPercentInfo">--</span>
                            </div>
                            <div class="dc-row dc-row-2">
                                <span class="dc-key">VOLT</span>
                                <span class="dc-value" data-source="batteryVoltage">--</span>
                            </div>
                            <div class="dc-row dc-row-3">
                                <span class="dc-key">CURR</span>
                                <span class="dc-value" data-source="batteryCurrent">--</span>
                            </div>
                            <div class="dc-row dc-row-4">
                                <span class="dc-key">STAT</span>
                                <span class="dc-value font-night-rain" data-source="batteryStateInfo">--</span>
                            </div>
                        </div>
                        <div class="data-column" data-column="audio">
                            <div class="dc-header">AUDIO</div>
                            <div class="dc-row dc-row-1">
                                <span class="dc-key">SPEAK</span>
                                <span class="dc-value font-arctic-ice" data-source="voiceSpeakingMs">0</span>
                            </div>
                            <div class="dc-row dc-row-2">
                                <span class="dc-key">VAD</span>
                                <span class="dc-value" data-source="vadSpeechMs">0</span>
                            </div>
                            <div class="dc-row dc-row-3">
                                <span class="dc-key">MIC</span>
                                <span class="dc-value font-night-rain" data-source="micInfo">--</span>
                            </div>
                            <div class="dc-row dc-row-4">
                                <span class="dc-key">VOICE</span>
                                <span class="dc-value font-alpha-blue" data-source="voiceTopic">/voice</span>
                            </div>
                        </div>
                        <div class="data-column" data-column="gps">
                            <div class="dc-header">GPS</div>
                            <div class="dc-row dc-row-1">
                                <span class="dc-key">FIX</span>
                                <span class="dc-value font-arctic-ice" data-source="gpsFixStatus">--</span>
                            </div>
                            <div class="dc-row dc-row-2">
                                <span class="dc-key">LAT</span>
                                <span class="dc-value" data-source="gpsLat">--</span>
                            </div>
                            <div class="dc-row dc-row-3">
                                <span class="dc-key">LON</span>
                                <span class="dc-value" data-source="gpsLon">--</span>
                            </div>
                            <div class="dc-row dc-row-4">
                                <span class="dc-key">ALT</span>
                                <span class="dc-value" data-source="gpsAlt">--</span>
                            </div>
                        </div>
                        <div class="data-column" data-column="network">
                            <div class="dc-header">NETWORK</div>
                            <div class="dc-row dc-row-1">
                                <span class="dc-key">CMD</span>
                                <span class="dc-value" data-source="cmdVelTopic">/cmd_vel</span>
                            </div>
                            <div class="dc-row dc-row-2">
                                <span class="dc-key">VOICE</span>
                                <span class="dc-value" data-source="voiceTopic">/voice</span>
                            </div>
                            <div class="dc-row dc-row-3">
                                <span class="dc-key">WEB</span>
                                <span class="dc-value" data-source="webAddress">--</span>
                            </div>
                            <div class="dc-row dc-row-4">
                                <span class="dc-key">WS</span>
                                <span class="dc-value" data-source="wsAddress">--</span>
                            </div>
                        </div>
                        <div class="data-column" data-column="host">
                            <div class="dc-header">HOST</div>
                            <div class="dc-row dc-row-1">
                                <span class="dc-key">CPU</span>
                                <span class="dc-value darkfont" data-source="cpuChip">--</span>
                            </div>
                            <div class="dc-row dc-row-2">
                                <span class="dc-key">TEMP</span>
                                <span class="dc-value font-alpha-blue" data-source="tempChip">--</span>
                            </div>
                            <div class="dc-row dc-row-3">
                                <span class="dc-key">MEM</span>
                                <span class="dc-value font-arctic-ice" data-source="memChip">--</span>
                            </div>
                            <div class="dc-row dc-row-4">
                                <span class="dc-key">DIAG</span>
                                <span class="dc-value font-night-rain" data-source="robotDiag">--</span>
                            </div>
                        </div>
                    </div>
                    <nav role="navigation" aria-label="pilot main navigation">
                        <div class="buttons justify-space-between">
                            <button onclick="playSoundAndRedirect('audio2', '#movement')"
                                class="button-bluey">Move</button>
                            <button onclick="playSoundAndRedirect('audio2', '#speech')"
                                class="button-bluey">Speak</button>
                            <button onclick="playSoundAndRedirect('audio2', '#navigation')"
                                class="button-default">Navigate</button>
                            <button onclick="playSoundAndRedirect('audio2', '#sensation')"
                                class="button-default">Sense</button>
                        </div>
                    </nav>
                </div>
                <div class="bar-panel first-bar-panel">
                    <div class="bar-1"> </div>
                    <div class="bar-2"> </div>
                    <div class="bar-3"> </div>
                    <div class="bar-4"> </div>
                    <div class="bar-5"> </div>
                </div>
            </div>
        </div>

        <div class="divider">
            <div class="block-left"> </div>
            <div class="block-right">
                <div class="block-row">
                    <div class="bar-11"> </div>
                    <div class="bar-12"> </div>
                    <div class="bar-13"> </div>
                    <div class="bar-14">
                        <div class="blockhead"> </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="wrap">
            <div class="left-frame">
                <button onclick="topFunction(); playSoundAndRedirect('audio4', '#')" id="topBtn"><span
                        class="hop">screen</span> top</button>

                <!-- decorative left-frame panels removed (values displayed in the data cascade) -->
            </div>
            <div class="right-frame">
                <div class="bar-panel">
                    <div class="bar-6"> </div>
                    <div class="bar-7"> </div>
                    <div class="bar-8"> </div>
                    <div class="bar-9"> </div>
                    <div class="bar-10"> </div>
                </div>
                <main>

                    <!-- Pilot content area -->

                    <section class="joystick-section">
                        <div class="lcars-text-bar">
                            <h2 class="go-center" id="movement">Movement Control</h2>
                        </div>
                        <div class="drive-grid">
                            <!-- D-Pad -->
                            <div class="dpad-section">
                                <div class="slider-title">D-Pad</div>
                                <div id="dpad" class="dpad-grid" aria-label="Directional pad controls">
                                    <div></div>
                                    <button id="dpadUp" class="dpad-btn up" data-direction="up"
                                        aria-label="Forward">▲</button>
                                    <div></div>
                                    <button id="dpadLeft" class="dpad-btn left" data-direction="left"
                                        aria-label="Left">◀</button>
                                    <div class="dpad-center" aria-hidden="true"></div>
                                    <button id="dpadRight" class="dpad-btn right" data-direction="right"
                                        aria-label="Right">▶</button>
                                    <div></div>
                                    <button id="dpadDown" class="dpad-btn down" data-direction="down"
                                        aria-label="Backward">▼</button>
                                    <div></div>
                                </div>
                            </div>

                            <!-- Joystick -->
                            <div class="joystick-container">
                                <div id="joystick" class="joystick" aria-label="Joystick" role="application">
                                    <div id="joystickKnob" class="joystick-knob" aria-hidden="true"></div>
                                    <svg id="imuOverlay" class="imu-overlay" viewBox="0 0 200 200"
                                        preserveAspectRatio="xMidYMid meet" aria-hidden="true">
                                        <defs>
                                            <marker id="arrowhead" markerWidth="6" markerHeight="6" refX="5" refY="3"
                                                orient="auto">
                                                <polygon points="0 0, 6 3, 0 6"></polygon>
                                            </marker>
                                        </defs>
                                        <circle cx="100" cy="100" r="88" fill="none" stroke-width="2" />
                                        <path id="imuGyroZ" d="" fill="none" stroke-width="6" stroke-linecap="round" />
                                        <line id="imuAccelVec" x1="100" y1="100" x2="100" y2="100"
                                            marker-end="url(#arrowhead)" />
                                    </svg>
                                </div>
                            </div>

                        </div>

                        <div class="aux-controls">
                            <div class="controls buttons justify-space-evenly">
                                <button id=" resetButton" class="reset-button">Reset</button>
                                <button id="stopButton" class="blink stop-button button-sunset-red"
                                    onclick="playSoundAndRedirect('audio3', '#movement');/* todo: stop the robot!*/">Emergency
                                    Stop</button>
                            </div>
                            <div id="speech" class="voice-controls">
                                <div class="lcars-text-bar">
                                    <h3>Voice</h3>
                                </div>
                                <div class="voice-row">
                                    <input id="voiceInput" type="text"
                                        placeholder="Type something for the robot to say..." />
                                    <div class="buttons">
                                        <button id="voiceSendButton" class="voice-button">Speak</button>
                                        <button id="marcoButton" class="voice-button button-bluey">Marco?</button>
                                    </div>
                                </div>
                                <div class="buttons">
                                    <button id="voicePause" class="button-default">Pause</button>
                                    <button id="voiceResume" class="button-default">Resume</button>
                                    <button id="voiceClear" class="button-bluey">Clear</button>
                                    <label for="voiceVolume">Volume</label>
                                    <input id="voiceVolume" type="range" min="0" max="200" value="100" />
                                    <span id="voiceVolumeValue">100%</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="info-section" id="sensation">
                        <div class="lcars-text-bar">
                            <h2 class="go-center">Control Information</h2>
                        </div>
                        <div class=" info-grid">
                            <div class="info-item"><label>Linear X</label><span id="linearX">0.00</span></div>
                            <div class="info-item"><label>Linear Y</label><span id="linearY">0.00</span></div>
                            <div class="info-item"><label>Angular Z</label><span id="angularZ">0.00</span></div>
                            <div class="info-item"><label>Mode</label><span id="robotMode">--</span></div>
                            <div class="info-item"><label>Speed (m/s)</label><span id="robotSpeed">--</span></div>
                            <div class="info-item"><label>Bumper</label><span id="robotBumper">--</span></div>
                            <div class="info-item"><label>Cliff</label><span id="robotCliff">--</span></div>
                            <div class="info-item"><label>IR Omni</label><span id="robotIrOmni">--</span></div>
                            <div class="info-item"><label>Diagnostics</label><span id="robotDiag">--</span></div>
                            <div class="info-item"><label>Battery %</label><span id="batteryPercentInfo">--</span>
                            </div>
                            <div class="info-item"><label>Voltage (V)</label><span id="batteryVoltage">--</span>
                            </div>
                            <div class="info-item"><label>Current (A)</label><span id="batteryCurrent">--</span>
                            </div>
                            <div class="info-item"><label>Temperature</label><span id="batteryTemp">--</span></div>
                            <div class="info-item"><label>State</label><span id="batteryStateInfo">--</span></div>
                            <div class="info-item"><label>CPU Load</label><span id="cpuChip">--</span></div>
                            <div class="info-item"><label>Main Temp</label><span id="tempChip">--</span></div>
                            <div class="info-item"><label>Memory</label><span id="memChip">--</span></div>
                            <div class="info-item"><label>Speaking (ms)</label><span id="voiceSpeakingMs">0</span>
                            </div>
                            <div class="info-item"><label>VAD Speech (ms)</label><span id="vadSpeechMs">0</span>
                            </div>
                            <div class="info-item"><label>Mic</label><span id="micInfo">--</span></div>
                            <div class="info-item"><label>GPS Fix</label><span id="gpsFixStatus">--</span></div>
                            <div class="info-item"><label>Latitude</label><span id="gpsLat">--</span></div>
                            <div class="info-item"><label>Longitude</label><span id="gpsLon">--</span></div>
                            <div class="info-item"><label>Altitude (m)</label><span id="gpsAlt">--</span></div>
                        </div>
                    </section>

                    <section class="conversation">
                        <div class="lcars-text-bar">
                            <h3>Conversation</h3>
                        </div>
                        <div id="conversationLog" aria-live="polite"></div>
                    </section>

                </main>
                <footer>
                    <div class="connection-info">
                        <div>Web: <span id="webAddress"></span></div>
                        <div>WebSocket: <span id="wsAddress"></span></div>
                        <div>Publishing to: <strong id="cmdVelTopic">/cmd_vel</strong></div>
                        <div>Voice topic: <strong id="voiceTopic">/voice</strong></div>
                    </div>
                </footer>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="assets/lcars.js"></script>
    <script src="joystick.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cascadeEl = document.getElementById('controlCascade');
            if (!cascadeEl) {
                return;
            }

            const valueEls = Array.from(cascadeEl.querySelectorAll('[data-source]'));
            if (!valueEls.length) {
                return;
            }

            const sourceMap = new Map();
            valueEls.forEach(el => {
                const key = el.getAttribute('data-source');
                if (!key) {
                    return;
                }
                if (!sourceMap.has(key)) {
                    sourceMap.set(key, []);
                }
                sourceMap.get(key).push(el);
            });

            const readSourceValue = (source) => {
                if (!source) {
                    return '';
                }
                if (source instanceof HTMLInputElement || source instanceof HTMLSelectElement || source instanceof HTMLTextAreaElement) {
                    return source.value;
                }
                return source.textContent || '';
            };

            const formatValue = (raw) => {
                const text = (raw || '').trim();
                if (!text) {
                    return '--';
                }
                if (/^-?\d+(?:\.\d+)?$/.test(text)) {
                    const num = parseFloat(text);
                    const magnitude = Math.abs(num);
                    if (magnitude >= 1000) {
                        return num.toFixed(0);
                    }
                    if (magnitude >= 100) {
                        return num.toFixed(1);
                    }
                    if (magnitude >= 10) {
                        return num.toFixed(2);
                    }
                    if (magnitude >= 1) {
                        return num.toFixed(2);
                    }
                    if (magnitude === 0) {
                        return '0';
                    }
                    return num.toFixed(3);
                }
                return text.length > 14 ? `${text.slice(0, 13)}…` : text;
            };

            const updateTargets = (id) => {
                const targets = sourceMap.get(id);
                if (!targets) {
                    return;
                }
                const source = document.getElementById(id);
                const formatted = formatValue(readSourceValue(source));
                targets.forEach(el => {
                    el.textContent = formatted;
                    if (source) {
                        el.classList.remove('dc-value--missing');
                    } else {
                        el.classList.add('dc-value--missing');
                    }
                });
            };

            const observerConfig = { childList: true, characterData: true, subtree: true };
            sourceMap.forEach((_, id) => {
                const source = document.getElementById(id);
                if (!source) {
                    updateTargets(id);
                    return;
                }

                const observer = new MutationObserver(() => updateTargets(id));
                observer.observe(source, observerConfig);

                if (source instanceof HTMLInputElement || source instanceof HTMLSelectElement || source instanceof HTMLTextAreaElement) {
                    const handler = () => updateTargets(id);
                    source.addEventListener('input', handler);
                    source.addEventListener('change', handler);
                }

                updateTargets(id);
            });

            document.addEventListener('pilot:cascade:sync', (event) => {
                const detail = event.detail;
                if (!detail || !detail.id) {
                    return;
                }
                updateTargets(detail.id);
            });
        });
    </script>
    <div class="headtrim"> </div>
    <div class="baseboard"> </div>
</body>

</html>
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Knightykell Pilot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="date=no">
    <link rel="stylesheet" type="text/css" href="assets/lower-decks-padd.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script defer src="https://unpkg.com/alpinejs@3.14.4/dist/cdn.min.js"></script>
</head>

<body x-data="pilotApp">
    <audio id="audio1" src="assets/beep1.mp3" preload="auto"></audio>
    <audio id="audio2" src="assets/beep2.mp3" preload="auto"></audio>
    <audio id="audio3" src="assets/beep3.mp3" preload="auto"></audio>
    <audio id="audio4" src="assets/beep4.mp3" preload="auto"></audio>
    <!-- Templates for control cascade columns -->
    <template id="tmpl-drive">
        <div class="data-column" data-column="drive" role="listitem">
            <div class="dc-header font-arctic-ice">DRIVE</div>
            <div class="dc-row dc-row-1">
                <span class="dc-key">LIN X</span>
                <span class="dc-value font-arctic-ice blink" data-source="linearX"
                    x-text="$store.pilot.twist.linearX">0.00</span>
            </div>
            <div class="dc-row dc-row-2">
                <span class="dc-key">LIN Y</span>
                <span class="dc-value font-night-rain" data-source="linearY"
                    x-text="$store.pilot.twist.linearY">0.00</span>
            </div>
            <div class="dc-row dc-row-3">
                <span class="dc-key">ANG Z</span>
                <span class="dc-value font-alpha-blue" data-source="angularZ"
                    x-text="$store.pilot.twist.angularZ">0.00</span>
            </div>
            <div class="dc-row dc-row-4">
                <span class="dc-key">MODE</span>
                <span class="dc-value font-arctic-ice" data-source="robotMode"
                    x-text="$store.pilot.robot.mode">--</span>
            </div>
        </div>
    </template>
    <template id="tmpl-safety">
        <div class="data-column" data-column="safety" role="listitem">
            <div class="dc-header">SAFETY</div>
            <div class="dc-row dc-row-1">
                <span class="dc-key">SPEED</span>
                <span class="dc-value font-arctic-ice" data-source="robotSpeed"
                    x-text="$store.pilot.robot.speed">--</span>
            </div>
            <div class="dc-row dc-row-2">
                <span class="dc-key">BUMPR</span>
                <span class="dc-value font-night-rain blink" data-source="robotBumper"
                    x-text="$store.pilot.robot.bumper">--</span>
            </div>
            <div class="dc-row dc-row-3">
                <span class="dc-key">CLIFF</span>
                <span class="dc-value font-night-rain" data-source="robotCliff"
                    x-text="$store.pilot.robot.cliff">--</span>
            </div>
            <div class="dc-row dc-row-4">
                <span class="dc-key">IR</span>
                <span class="dc-value font-alpha-blue" data-source="robotIrOmni"
                    x-text="$store.pilot.robot.ir">--</span>
            </div>
        </div>
    </template>
    <template id="tmpl-energy">
        <div class="data-column" data-column="energy" role="listitem">
            <div class="dc-header">ENERGY</div>
            <div class="dc-row dc-row-1">
                <span class="dc-key">BAT %</span>
                <span class="dc-value font-arctic-ice blink" data-source="batteryPercentInfo"
                    x-text="$store.pilot.battery.percent">--</span>
            </div>
            <div class="dc-row dc-row-2">
                <span class="dc-key">VOLT</span>
                <span class="dc-value" data-source="batteryVoltage" x-text="$store.pilot.battery.voltage">--</span>
            </div>
            <div class="dc-row dc-row-3">
                <span class="dc-key">CURR</span>
                <span class="dc-value" data-source="batteryCurrent" x-text="$store.pilot.battery.current">--</span>
            </div>
            <div class="dc-row dc-row-4">
                <span class="dc-key">STAT</span>
                <span class="dc-value font-night-rain" data-source="batteryStateInfo"
                    x-text="$store.pilot.battery.state">--</span>
            </div>
        </div>
    </template>
    <template id="tmpl-audio">
        <div class="data-column" data-column="audio" role="listitem">
            <div class="dc-header">AUDIO</div>
            <div class="dc-row dc-row-1">
                <span class="dc-key">SPEAK</span>
                <span class="dc-value font-arctic-ice" data-source="voiceSpeakingMs"
                    x-text="$store.pilot.audio.speakingMs">0</span>
            </div>
            <div class="dc-row dc-row-2">
                <span class="dc-key">VAD</span>
                <span class="dc-value" data-source="vadSpeechMs" x-text="$store.pilot.audio.vadMs">0</span>
            </div>
            <div class="dc-row dc-row-3">
                <span class="dc-key">MIC</span>
                <span class="dc-value font-night-rain" data-source="micInfo" x-text="$store.pilot.audio.mic">--</span>
            </div>
            <div class="dc-row dc-row-4">
                <span class="dc-key">VOICE</span>
                <span class="dc-value font-alpha-blue" data-source="voiceTopic"
                    x-text="$store.pilot.addresses.voiceSubscribers !== null ? `${$store.pilot.addresses.voice} (${$store.pilot.addresses.voiceSubscribers} subscribers)` : $store.pilot.addresses.voice">/voice</span>
            </div>
        </div>
    </template>
    <template id="tmpl-gps">
        <div class="data-column" data-column="gps" role="listitem">
            <div class="dc-header">GPS</div>
            <div class="dc-row dc-row-1">
                <span class="dc-key">FIX</span>
                <span class="dc-value font-arctic-ice" data-source="gpsFixStatus"
                    x-text="$store.pilot.gps.fix">--</span>
            </div>
            <div class="dc-row dc-row-2">
                <span class="dc-key">LAT</span>
                <span class="dc-value" data-source="gpsLat" x-text="$store.pilot.gps.lat">--</span>
            </div>
            <div class="dc-row dc-row-3">
                <span class="dc-key">LON</span>
                <span class="dc-value" data-source="gpsLon" x-text="$store.pilot.gps.lon">--</span>
            </div>
            <div class="dc-row dc-row-4">
                <span class="dc-key">ALT</span>
                <span class="dc-value" data-source="gpsAlt" x-text="$store.pilot.gps.alt">--</span>
            </div>
        </div>
    </template>
    <template id="tmpl-network">
        <div class="data-column" data-column="network" role="listitem">
            <div class="dc-header">NETWORK</div>
            <div class="dc-row dc-row-1">
                <span class="dc-key">CMD</span>
                <span class="dc-value" data-source="cmdVelTopic"
                    x-text="$store.pilot.addresses.cmdVelSubscribers !== null ? `${$store.pilot.addresses.cmdVel} (${$store.pilot.addresses.cmdVelSubscribers} subscribers)` : $store.pilot.addresses.cmdVel">/cmd_vel</span>
            </div>
            <div class="dc-row dc-row-2">
                <span class="dc-key">VOICE</span>
                <span class="dc-value" data-source="voiceTopic"
                    x-text="$store.pilot.addresses.voiceSubscribers !== null ? `${$store.pilot.addresses.voice} (${$store.pilot.addresses.voiceSubscribers} subscribers)` : $store.pilot.addresses.voice">/voice</span>
            </div>
            <div class="dc-row dc-row-3">
                <span class="dc-key">WEB</span>
                <span class="dc-value" data-source="webAddress" x-text="$store.pilot.addresses.web">--</span>
            </div>
            <div class="dc-row dc-row-4">
                <span class="dc-key">WS</span>
                <span class="dc-value" data-source="wsAddress" x-text="$store.pilot.addresses.ws">--</span>
            </div>
        </div>
    </template>
    <template id="tmpl-host">
        <div class="data-column" data-column="host" role="listitem">
            <div class="dc-header">HOST</div>
            <div class="dc-row dc-row-1">
                <span class="dc-key">CPU</span>
                <span class="dc-value darkfont" data-source="cpuChip" x-text="$store.pilot.host.cpu">--</span>
            </div>
            <div class="dc-row dc-row-2">
                <span class="dc-key">TEMP</span>
                <span class="dc-value font-alpha-blue" data-source="tempChip" x-text="$store.pilot.host.temp">--</span>
            </div>
            <div class="dc-row dc-row-3">
                <span class="dc-key">MEM</span>
                <span class="dc-value font-arctic-ice" data-source="memChip" x-text="$store.pilot.host.mem">--</span>
            </div>
            <div class="dc-row dc-row-4">
                <span class="dc-key">DIAG</span>
                <span class="dc-value font-night-rain" data-source="robotDiag"
                    x-text="$store.pilot.robot.diag">--</span>
            </div>
        </div>
    </template>
    <div class="wrap-all">
        <div class="wrap">
            <div class="left-frame-top">
                <button onclick="playSoundAndRedirect('audio2', '#')" class="panel-1-button">KNIGHTYKELL</button>
                <div class="panel-2">02<span class="hop">-262000</span></div>
            </div>
            <div class="right-frame-top">
                <div class="banner">Pilot Interface &bull;
                    <span class="font-alpha-blue" data-source="connectionStatus"
                        x-text="$store.pilot.connection.label">Offline</span>
                </div>
                <div class="data-cascade-button-group">
                    <div class="data-wrapper" id="controlCascade" role="group" aria-label="Control status cascade">
                        <!-- container that will be populated from templates on load -->
                        <div id="controlCascadeContent" class="data-columns-grid" role="list"></div>
                    </div>
                    <nav role="navigation" aria-label="pilot main navigation">
                        <div class="buttons justify-space-between">
                            <button onclick="playSoundAndRedirect('audio2', '#movement')"
                                class="button-bluey">Move</button>
                            <button onclick="playSoundAndRedirect('audio2', '#speech')"
                                class="button-bluey">Speak</button>
                            <button onclick="playSoundAndRedirect('audio2', '#navigation')"
                                class="button-default">Navigate</button>
                            <button onclick="playSoundAndRedirect('audio2', '#sensation')"
                                class="button-default">Sense</button>
                        </div>
                    </nav>
                </div>
                <div class="bar-panel first-bar-panel">
                    <div class="bar-1"> </div>
                    <div class="bar-2"> </div>
                    <div class="bar-3"> </div>
                    <div class="bar-4"> </div>
                    <div class="bar-5"> </div>
                </div>
            </div>
        </div>

        <div class="divider">
            <div class="block-left"> </div>
            <div class="block-right">
                <div class="block-row">
                    <div class="bar-11"> </div>
                    <div class="bar-12"> </div>
                    <div class="bar-13"> </div>
                    <div class="bar-14">
                        <div class="blockhead"> </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="wrap">
            <div class="left-frame">

                <button onclick="topFunction(); playSoundAndRedirect('audio4', '#')" id="topBtn"><span
                        class="hop">screen</span> top</button>

                <div>
                    <a class="panel-button pan-3 text-bottom" href="#speech">03<span class="hop">-111968</span></a>
                    <a class="panel-button pan-4 text-bottom" href="#navigation">04<span class="hop">-041969</span></a>
                    <a class="panel-button pan-5 text-bottom" href="#sensation">05<span class="hop">-1701D</span></a>
                    <a class="panel-button pan-6 text-bottom" href="#movement">06<span class="hop">-071984</span></a>
                </div>
            </div>
            <div class="right-frame">
                <div class="bar-panel">
                    <div class="bar-6"> </div>
                    <div class="bar-7"> </div>
                    <div class="bar-8"> </div>
                    <div class="bar-9"> </div>
                    <div class="bar-10"> </div>
                </div>
                <main>

                    <!-- Pilot content area -->

                    <section class="joystick-section">
                        <div class="lcars-text-bar">
                            <h2 class="go-center" id="movement">Movement Control</h2>
                        </div>
                        <div class="drive-grid">
                            <!-- D-Pad removed: using enlarged joystick for finer control -->

                            <!-- Joystick -->
                            <div class="joystick-container">
                                <div id="joystick" class="joystick" aria-label="Joystick" role="application">
                                    <div id="joystickKnob" class="joystick-knob" aria-hidden="true"></div>
                                    <svg id="imuOverlay" class="imu-overlay" viewBox="0 0 200 200"
                                        preserveAspectRatio="xMidYMid meet" aria-hidden="true">
                                        <defs>
                                            <marker id="arrowhead" markerWidth="6" markerHeight="6" refX="5" refY="3"
                                                orient="auto">
                                                <polygon points="0 0, 6 3, 0 6"></polygon>
                                            </marker>
                                        </defs>
                                        <circle cx="100" cy="100" r="88" fill="none" stroke-width="2" />
                                        <path id="imuGyroZ" d="" fill="none" stroke-width="6" stroke-linecap="round" />
                                        <line id="imuAccelVec" x1="100" y1="100" x2="100" y2="100"
                                            marker-end="url(#arrowhead)" />
                                    </svg>
                                </div>
                            </div>

                        </div>

                        <div class="aux-controls">
                            <div class="controls buttons justify-space-evenly">
                                <button id="resetButton" class="reset-button">Reset</button>
                                <button id="stopButton" class="blink stop-button button-sunset-red"
                                    onclick="playSoundAndRedirect('audio3', '#movement');/* todo: stop the robot!*/">Emergency
                                    Stop</button>
                            </div>
                            <div id="speech" class="voice-controls">
                                <div class="lcars-text-bar">
                                    <h3>Voice</h3>
                                </div>
                                <div class="voice-row">
                                    <input id="voiceInput" type="text"
                                        placeholder="Type something for the robot to say..." />
                                    <div class="buttons">
                                        <button id="voiceSendButton" class="voice-button">Speak</button>
                                        <button id="marcoButton" class="voice-button button-bluey">Marco?</button>
                                    </div>
                                </div>
                                <div class="buttons">
                                    <button id="voicePause" class="button-default">Pause</button>
                                    <button id="voiceResume" class="button-default">Resume</button>
                                    <button id="voiceClear" class="button-bluey">Clear</button>
                                    <label for="voiceVolume">Volume</label>
                                    <input id="voiceVolume" type="range" min="0" max="200" value="100" />
                                    <span id="voiceVolumeValue">100%</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="info-section" id="sensation">
                        <div class="lcars-text-bar">
                            <h2 class="go-center">Control Information</h2>
                        </div>
                        <div class=" info-grid">
                            <div class="info-item"><label>Linear X</label><span id="linearX"
                                    x-text="$store.pilot.twist.linearX">0.00</span></div>
                            <div class="info-item"><label>Linear Y</label><span id="linearY"
                                    x-text="$store.pilot.twist.linearY">0.00</span></div>
                            <div class="info-item"><label>Angular Z</label><span id="angularZ"
                                    x-text="$store.pilot.twist.angularZ">0.00</span></div>
                            <div class="info-item"><label>Mode</label><span id="robotMode"
                                    x-text="$store.pilot.robot.mode">--</span></div>
                            <div class="info-item"><label>Speed (m/s)</label><span id="robotSpeed"
                                    x-text="$store.pilot.robot.speed">--</span></div>
                            <div class="info-item"><label>Bumper</label><span id="robotBumper"
                                    x-text="$store.pilot.robot.bumper">--</span></div>
                            <div class="info-item"><label>Cliff</label><span id="robotCliff"
                                    x-text="$store.pilot.robot.cliff">--</span></div>
                            <div class="info-item"><label>IR Omni</label><span id="robotIrOmni"
                                    x-text="$store.pilot.robot.ir">--</span></div>
                            <div class="info-item"><label>Diagnostics</label><span id="robotDiag"
                                    x-text="$store.pilot.robot.diag">--</span></div>
                            <div class="info-item"><label>Battery %</label><span id="batteryPercentInfo"
                                    x-text="$store.pilot.battery.percent">--</span>
                            </div>
                            <div class="info-item"><label>Voltage (V)</label><span id="batteryVoltage"
                                    x-text="$store.pilot.battery.voltage">--</span>
                            </div>
                            <div class="info-item"><label>Current (A)</label><span id="batteryCurrent"
                                    x-text="$store.pilot.battery.current">--</span>
                            </div>
                            <div class="info-item"><label>Temperature</label><span id="batteryTemp"
                                    x-text="$store.pilot.battery.temperature">--</span></div>
                            <div class="info-item"><label>State</label><span id="batteryStateInfo"
                                    x-text="$store.pilot.battery.state">--</span></div>
                            <div class="info-item"><label>CPU Load</label><span id="cpuChip"
                                    x-text="$store.pilot.host.cpu">--</span></div>
                            <div class="info-item"><label>Main Temp</label><span id="tempChip"
                                    x-text="$store.pilot.host.temp">--</span></div>
                            <div class="info-item"><label>Memory</label><span id="memChip"
                                    x-text="$store.pilot.host.mem">--</span></div>
                            <div class="info-item"><label>Speaking (ms)</label><span id="voiceSpeakingMs"
                                    x-text="$store.pilot.audio.speakingMs">0</span>
                            </div>
                            <div class="info-item"><label>VAD Speech (ms)</label><span id="vadSpeechMs"
                                    x-text="$store.pilot.audio.vadMs">0</span>
                            </div>
                            <div class="info-item"><label>Mic</label><span id="micInfo"
                                    x-text="$store.pilot.audio.mic">--</span></div>
                            <div class="info-item"><label>GPS Fix</label><span id="gpsFixStatus"
                                    x-text="$store.pilot.gps.fix">--</span></div>
                            <div class="info-item"><label>Latitude</label><span id="gpsLat"
                                    x-text="$store.pilot.gps.lat">--</span></div>
                            <div class="info-item"><label>Longitude</label><span id="gpsLon"
                                    x-text="$store.pilot.gps.lon">--</span></div>
                            <div class="info-item"><label>Altitude (m)</label><span id="gpsAlt"
                                    x-text="$store.pilot.gps.alt">--</span></div>
                        </div>
                    </section>

                    <section class="conversation">
                        <div class="lcars-text-bar">
                            <h3>Conversation</h3>
                        </div>
                        <div id="conversationLog" aria-live="polite"></div>
                    </section>

                </main>
                <footer>
                    <div class="connection-info">
                        <div>Web: <span id="webAddress" x-text="$store.pilot.addresses.web"></span></div>
                        <div>WebSocket: <span id="wsAddress" x-text="$store.pilot.addresses.ws"></span></div>
                        <div>Publishing to: <strong id="cmdVelTopic"
                                x-text="$store.pilot.addresses.cmdVelSubscribers !== null ? `${$store.pilot.addresses.cmdVel} (${$store.pilot.addresses.cmdVelSubscribers} subscribers)` : $store.pilot.addresses.cmdVel">/cmd_vel</strong>
                        </div>
                        <div>Voice topic: <strong id="voiceTopic"
                                x-text="$store.pilot.addresses.voiceSubscribers !== null ? `${$store.pilot.addresses.voice} (${$store.pilot.addresses.voiceSubscribers} subscribers)` : $store.pilot.addresses.voice">/voice</strong>
                        </div>
                    </div>
                </footer>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="assets/lcars.js"></script>
    <script src="joystick.js"></script>
    <style>
        /* Make the data columns responsive and auto-fit across wide screens */
        .data-columns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 8px;
            align-items: start;
        }

        /* Ensure individual column styling remains consistent */
        .data-column {
            background: transparent;
            /* keep existing visual look */
            padding: 4px 8px;
        }

        @media (min-width: 1200px) {
            .data-columns-grid {
                gap: 12px;
            }
        }

        /* Enlarged joystick for finer-grained control */
        .drive-grid {
            display: grid;
            grid-template-columns: 1fr auto; /* joystick column and aux column */
            gap: 16px;
            align-items: center;
        }

        /* Center joystick and cap its size for small screens */
        .joystick-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px 0;
        }

        /* Double the effective joystick size. The SVG uses 200x200 viewBox so 400px gives 2x scale. */
        .joystick {
            width: 400px;
            height: 400px;
            max-width: 90vw;
            max-height: 90vw;
            touch-action: none; /* allow pointer events without browser gestures */
            position: relative;
        }

        /* Make the knob scale proportionally to the larger joystick */
        .joystick .joystick-knob {
            width: 20%;
            height: 20%;
            max-width: 120px;
            max-height: 120px;
            border-radius: 50%;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        @media (max-width: 600px) {
            .joystick {
                width: 300px;
                height: 300px;
            }
        }
    </style>

    <script>
        // Populate the control cascade from templates so columns are reusable
        document.addEventListener('DOMContentLoaded', function () {
            const order = [
                'tmpl-drive',
                'tmpl-safety',
                'tmpl-energy',
                'tmpl-audio',
                'tmpl-gps',
                'tmpl-network',
                'tmpl-host'
            ];
            const container = document.getElementById('controlCascadeContent');
            if (!container) return;
            order.forEach(id => {
                const tmpl = document.getElementById(id);
                if (!tmpl) return;
                const clone = tmpl.content.cloneNode(true);
                container.appendChild(clone);
            });

            // If Alpine is present, re-initialize it so bindings on the cloned nodes work
            if (window.Alpine && typeof window.Alpine.initTree === 'function') {
                // Alpine v3: init a fresh tree from the container
                window.Alpine.initTree(container);
            } else if (window.Alpine && typeof window.Alpine.discover === 'function') {
                // Fallback: let Alpine discover new elements
                window.Alpine.discover(function () { });
            }
        });
    </script>
    <div class="headtrim"> </div>
    <div class="baseboard"> </div>
</body>

</html>
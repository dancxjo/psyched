<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Knightykell Pilot</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="date=no">
    <link rel="stylesheet" type="text/css" href="assets/lower-decks-padd.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>

<body>
    <audio id="audio1" src="assets/beep1.mp3" preload="auto"></audio>
    <audio id="audio2" src="assets/beep2.mp3" preload="auto"></audio>
    <audio id="audio3" src="assets/beep3.mp3" preload="auto"></audio>
    <audio id="audio4" src="assets/beep4.mp3" preload="auto"></audio>
    <div class="wrap-all">
        <div class="wrap">
            <div class="left-frame-top">
                <button onclick="playSoundAndRedirect('audio2', '#')" class="panel-1-button">KNIGHTYKELL</button>
                <div class="panel-2">02<span class="hop">-262000</span></div>
            </div>
            <div class="right-frame-top">
                <div class="banner">Pilot Interface</div>
                <div class="data-cascade-button-group">
                    <div class="data-wrapper" x-data="dataCascade()" x-init="init()">
                        <!-- Labels row (uses same columns array) -->
                        <div class="data-labels">
                            <template x-for="(col, idx) in columns" :key="'label-'+idx">
                                <div class="data-column">
                                    <div class="dc-row-1 dc-label" x-text="col.label || ''"></div>
                                </div>
                            </template>
                        </div>
                        <!-- Numeric data rows -->
                        <template x-for="(col, idx) in columns" :key="idx">
                            <div class="data-column">
                                <div class="dc-row-1" :class="col.r1Class" x-text="valueFor(col.r1)"></div>
                                <div class="dc-row-2" :class="col.r2Class" x-text="valueFor(col.r2)"></div>
                                <div class="dc-row-3" :class="col.r3Class" x-text="valueFor(col.r3)"></div>
                                <div class="dc-row-4" :class="col.r4Class" x-text="valueFor(col.r4)"></div>
                            </div>
                        </template>
                    </div>
                    <nav role="navigation" aria-label="pilot main navigation">
                        <div class="buttons justify-space-between">
                            <button onclick="playSoundAndRedirect('audio2', '#')" class="button-bluey">MOVEMENT</button>
                            <button onclick="playSoundAndRedirect('audio2', '#')"
                                class="blink button-almond-creme">SPEECH</button>
                            <button onclick="playSoundAndRedirect('audio2', '#')"
                                class="button-default">NAVIGATION</button>
                            <button onclick="playSoundAndRedirect('audio2', '#')"
                                class="button-default">SENSATION</button>
                        </div>
                    </nav>
                </div>
                <div class="bar-panel first-bar-panel">
                    <div class="bar-1"> </div>
                    <div class="bar-2"> </div>
                    <div class="bar-3"> </div>
                    <div class="bar-4"> </div>
                    <div class="bar-5"> </div>
                </div>
            </div>
        </div>

        <div class="divider">
            <div class="block-left"> </div>
            <div class="block-right">
                <div class="block-row">
                    <div class="bar-11"> </div>
                    <div class="bar-12"> </div>
                    <div class="bar-13"> </div>
                    <div class="bar-14">
                        <div class="blockhead"> </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="wrap">
            <div class="left-frame">
                <button onclick="topFunction(); playSoundAndRedirect('audio4', '#')" id="topBtn"><span
                        class="hop">screen</span> top</button>

                <!-- decorative left-frame panels removed (values displayed in the data cascade) -->
            </div>
            <div class="right-frame">
                <div class="bar-panel">
                    <div class="bar-6"> </div>
                    <div class="bar-7"> </div>
                    <div class="bar-8"> </div>
                    <div class="bar-9"> </div>
                    <div class="bar-10"> </div>
                </div>
                <main>

                    <!-- Pilot content area -->

                    <section class="joystick-section">
                        <div class="lcars-text-bar">
                            <h2 class="go-center">Movement Control</h2>
                        </div>
                        <div class="drive-grid">
                            <!-- D-Pad -->
                            <div class="dpad-section">
                                <div class="slider-title">D-Pad</div>
                                <div id="dpad" class="dpad-grid" aria-label="Directional pad controls">
                                    <div></div>
                                    <button id="dpadUp" class="dpad-btn up" aria-label="Forward">▲</button>
                                    <div></div>
                                    <button id="dpadLeft" class="dpad-btn left" aria-label="Left">◀</button>
                                    <div class="dpad-center" aria-hidden="true"></div>
                                    <button id="dpadRight" class="dpad-btn right" aria-label="Right">▶</button>
                                    <div></div>
                                    <button id="dpadDown" class="dpad-btn down" aria-label="Backward">▼</button>
                                    <div></div>
                                </div>
                            </div>

                            <!-- Joystick -->
                            <div class="joystick-container">
                                <div id="joystick" class="joystick" aria-label="Joystick" role="application">
                                    <div id="joystickKnob" class="joystick-knob" aria-hidden="true"></div>
                                    <svg id="imuOverlay" class="imu-overlay" viewBox="0 0 200 200"
                                        preserveAspectRatio="xMidYMid meet" aria-hidden="true">
                                        <defs>
                                            <marker id="arrowhead" markerWidth="6" markerHeight="6" refX="5" refY="3"
                                                orient="auto">
                                                <polygon points="0 0, 6 3, 0 6"></polygon>
                                            </marker>
                                        </defs>
                                        <circle cx="100" cy="100" r="88" fill="none" stroke-width="2" />
                                        <path id="imuGyroZ" d="" fill="none" stroke-width="6" stroke-linecap="round" />
                                        <line id="imuAccelVec" x1="100" y1="100" x2="100" y2="100"
                                            marker-end="url(#arrowhead)" />
                                    </svg>
                                </div>
                                <div class="joystick-labels">
                                    <span class="label-forward">FWD</span>
                                    <span class="label-backward">REV</span>
                                    <span class="label-left">L</span>
                                    <span class="label-right">R</span>
                                </div>
                            </div>

                        </div>

                        <div class="aux-controls">
                            <div class="controls">
                                <button id="resetButton" class="reset-button">Reset</button>
                                <button id="stopButton" class="stop-button">Emergency Stop</button>
                            </div>
                            <div class="voice-controls">
                                <div class="lcars-text-bar">
                                    <h3>Voice</h3>
                                </div>
                                <div class="voice-row">
                                    <input id="voiceInput" type="text"
                                        placeholder="Type something for the robot to say..." />
                                    <button id="voiceSendButton" class="voice-button">Speak</button>
                                    <button id="marcoButton" class="voice-button">Marco?</button>
                                </div>
                                <div class="voice-row">
                                    <button id="voicePause" class="voice-button">Pause</button>
                                    <button id="voiceResume" class="voice-button">Resume</button>
                                    <button id="voiceClear" class="voice-button">Clear</button>
                                    <label for="voiceVolume">Volume</label>
                                    <input id="voiceVolume" type="range" min="0" max="200" value="100" />
                                    <span id="voiceVolumeValue">100%</span>
                                </div>
                                <div id="voiceHint">Press Enter to send</div>
                            </div>
                        </div>
                    </section>

                    <section class="info-section">
                        <div class="lcars-text-bar">
                            <h2 class="go-center">Control Information</h2>
                        </div>
                        <div class="info-grid">
                            <div class="info-item"><label>Linear X</label><span id="linearX">0.00</span></div>
                            <div class="info-item"><label>Linear Y</label><span id="linearY">0.00</span></div>
                            <div class="info-item"><label>Angular Z</label><span id="angularZ">0.00</span></div>
                            <div class="info-item"><label>Mode</label><span id="robotMode">--</span></div>
                            <div class="info-item"><label>Speed (m/s)</label><span id="robotSpeed">--</span></div>
                            <div class="info-item"><label>Bumper</label><span id="robotBumper">--</span></div>
                            <div class="info-item"><label>Cliff</label><span id="robotCliff">--</span></div>
                            <div class="info-item"><label>IR Omni</label><span id="robotIrOmni">--</span></div>
                            <div class="info-item"><label>Diagnostics</label><span id="robotDiag">--</span></div>
                            <div class="info-item"><label>Battery %</label><span id="batteryPercentInfo">--</span></div>
                            <div class="info-item"><label>Voltage (V)</label><span id="batteryVoltage">--</span></div>
                            <div class="info-item"><label>Current (A)</label><span id="batteryCurrent">--</span></div>
                            <div class="info-item"><label>Temperature</label><span id="batteryTemp">--</span></div>
                            <div class="info-item"><label>State</label><span id="batteryStateInfo">--</span></div>
                            <div class="info-item"><label>Speaking (ms)</label><span id="voiceSpeakingMs">0</span></div>
                            <div class="info-item"><label>VAD Speech (ms)</label><span id="vadSpeechMs">0</span></div>
                            <div class="info-item"><label>Mic</label><span id="micInfo">--</span></div>
                            <div class="info-item"><label>GPS Fix</label><span id="gpsFixStatus">--</span></div>
                            <div class="info-item"><label>Latitude</label><span id="gpsLat">--</span></div>
                            <div class="info-item"><label>Longitude</label><span id="gpsLon">--</span></div>
                            <div class="info-item"><label>Altitude (m)</label><span id="gpsAlt">--</span></div>
                        </div>
                    </section>

                    <section class="conversation">
                        <div class="lcars-text-bar">
                            <h3>Conversation</h3>
                        </div>
                        <div id="conversationLog" aria-live="polite"></div>
                    </section>

                </main>
                <footer>
                    <div class="connection-info">
                        <div>Web: <span id="webAddress"></span></div>
                        <div>WebSocket: <span id="wsAddress"></span></div>
                        <div>Publishing to: <strong id="cmdVelTopic">/cmd_vel</strong></div>
                        <div>Voice topic: <strong id="voiceTopic">/voice</strong></div>
                    </div>
                </footer>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="assets/lcars.js"></script>
    <script src="joystick.js"></script>
    <script>
        function dataCascade() {
            return {
                // Define columns as mappings to info-grid element IDs or static keys
                columns: [
                    { label: 'BAT %', r1: 'batteryPercentInfo', r2: 'robotSpeed', r3: 'robotMode', r4: 'robotBumper', r1Class: 'font-arctic-ice blink' },
                    { label: 'VEL', r1: 'linearX', r2: 'linearY', r3: 'angularZ', r4: 'gpsFixStatus', r1Class: 'blink' },
                    { label: 'BATT', r1: 'batteryVoltage', r2: 'batteryCurrent', r3: 'batteryTemp', r4: 'batteryStateInfo', r1Class: 'font-night-rain blink' },
                    { label: 'AUDIO', r1: 'voiceSpeakingMs', r2: 'vadSpeechMs', r3: 'micInfo', r4: 'voiceTopic', r1Class: 'font-arctic-ice blink' },
                    { label: 'GPS', r1: 'gpsLat', r2: 'gpsLon', r3: 'gpsAlt', r4: 'robotDiag', r1Class: 'font-arctic-ice blink' },
                    { label: 'HOST', r1: 'cpuChip', r2: 'tempChip', r3: 'memChip', r4: '', r1Class: 'darkspace darkfont blink' },
                    { label: 'SENS', r1: 'robotIrOmni', r2: 'robotCliff', r3: 'robotBumper', r4: 'robotMode' },
                    { label: 'NET', r1: 'cmdVelTopic', r2: 'voiceTopic', r3: 'webAddress', r4: 'wsAddress' },
                ],
                init() {
                    // Observe mutations to the info grid and force Alpine to update by toggling a dummy property
                    const ids = new Set();
                    this.columns.forEach(c => { [c.r1, c.r2, c.r3, c.r4].forEach(id => id && ids.add(id)); });
                    ids.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) {
                            const obs = new MutationObserver(() => this._touch = Date.now());
                            obs.observe(el, { childList: true, characterData: true, subtree: true });
                        }
                    });
                },
                valueFor(key) {
                    if (!key) return '';
                    const el = document.getElementById(key);
                    if (!el) return key;
                    // Read text content; format numbers to shorter form when very large
                    const v = (el.textContent || '').trim();
                    if (!v) return '--';
                    if (/^\d{10,}$/.test(v)) return v.slice(0, 11) + '…';
                    return v;
                }
            };
        }
    </script>
    <div class="headtrim"> </div>
    <div class="baseboard"> </div>
</body>

</html>